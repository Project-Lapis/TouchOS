<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
  margin: 0; background: #1e1e1e; font-family: "Menlo", "Monaco", "Courier New", monospace; 
  height: 100vh; display: flex; flex-direction: column; color: #d4d4d4;
}
.toolbar {
  height: 50px; background: #2d2d30; border-bottom: 1px solid #3e3e42;
  display: flex; align-items: center; padding: 0 15px; gap: 10px;
}
.toolbar select {
  flex: 1; max-width: 400px; padding: 8px 12px; background: #3c3c3c; color: #ccc; border: 1px solid #555;
  border-radius: 4px; font-size: 14px; font-family: inherit;
}
.toolbar button {
  padding: 8px 16px; background: #0e639c; color: white; border: none; border-radius: 4px;
  cursor: pointer; font-weight: 600; font-size: 13px;
}
.toolbar button:hover { background: #1177bb; }
.toolbar button:active { background: #0d5a8f; }
.toolbar button.danger { background: #d32f2f; }
.toolbar button.danger:hover { background: #f44336; }
.toolbar .spacer { flex: 1; }
.editor-container {
  flex: 1; display: flex; flex-direction: column; overflow: hidden;
}
.file-info {
  padding: 8px 15px; background: #252526; border-bottom: 1px solid #3e3e42;
  font-size: 12px; color: #858585;
}
textarea {
  flex: 1; width: 100%; padding: 15px; background: #1e1e1e; color: #d4d4d4;
  border: none; font-family: inherit; font-size: 14px; line-height: 1.6;
  resize: none; outline: none; tab-size: 2;
}
.status-bar {
  height: 30px; background: #007acc; display: flex; align-items: center;
  padding: 0 15px; font-size: 12px; color: white; font-weight: 600;
}
.console {
  height: 150px; background: #1e1e1e; border-top: 1px solid #3e3e42;
  overflow-y: auto; padding: 10px; font-size: 12px; color: #ccc;
}
.console-line { margin-bottom: 5px; }
.console-success { color: #4ec9b0; }
.console-error { color: #f48771; }
</style></head><body>
<div class="toolbar">
  <select id="file-select">
    <option value="">-- Select File to Edit --</option>
  </select>
  <button onclick="loadFile()">Load</button>
  <button onclick="saveFile()">Save</button>
  <button onclick="testFile()">Test</button>
  <div class="spacer"></div>
  <button onclick="newFile()">+ New</button>
  <button class="danger" onclick="deleteFile()">Delete</button>
</div>
<div class="editor-container">
  <div class="file-info" id="file-info">No file loaded</div>
  <textarea id="editor" placeholder="Select a file to start editing..." spellcheck="false"></textarea>
</div>
<div class="status-bar" id="status">Ready</div>
<div class="console" id="console"></div>

<script>
let currentFile = null;

function log(msg, type = '') {
  const consoleEl = document.getElementById('console');
  const line = document.createElement('div');
  line.className = 'console-line ' + (type === 'success' ? 'console-success' : type === 'error' ? 'console-error' : '');
  line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
  consoleEl.appendChild(line);
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

async function refreshFileList() {
  const select = document.getElementById('file-select');
  const currentValue = select.value;
  select.innerHTML = '<option value="">-- Select File to Edit --</option>';
  
  const apps = await parent.XLine.fs.list('/apps/');
  const system = await parent.XLine.fs.list('/system/');
  
  const optgroupApps = document.createElement('optgroup');
  optgroupApps.label = 'Applications';
  apps.forEach(path => {
    const opt = document.createElement('option');
    opt.value = path;
    opt.textContent = path;
    optgroupApps.appendChild(opt);
  });
  
  const optgroupSystem = document.createElement('optgroup');
  optgroupSystem.label = 'System';
  system.forEach(path => {
    if (!path.includes('.layout')) {
      const opt = document.createElement('option');
      opt.value = path;
      opt.textContent = path;
      optgroupSystem.appendChild(opt);
    }
  });
  
  select.appendChild(optgroupApps);
  select.appendChild(optgroupSystem);
  
  if (currentValue) {
    select.value = currentValue;
  }
}

async function loadFile() {
  const path = document.getElementById('file-select').value;
  if (!path) {
    log('Please select a file', 'error');
    return;
  }
  
  try {
    const content = await parent.XLine.fs.read(path);
    if (content) {
      document.getElementById('editor').value = content;
      currentFile = path;
      document.getElementById('file-info').textContent = 'Editing: ' + path + ' (' + content.length + ' chars)';
      document.getElementById('status').textContent = 'Loaded: ' + path;
      log('Loaded: ' + path, 'success');
    } else {
      log('File not found: ' + path, 'error');
    }
  } catch (e) {
    log('Error loading: ' + e.message, 'error');
  }
}

async function saveFile() {
  if (!currentFile) {
    log('No file loaded', 'error');
    return;
  }
  
  try {
    const content = document.getElementById('editor').value;
    await parent.XLine.fs.write(currentFile, content);
    document.getElementById('status').textContent = 'Saved: ' + currentFile;
    log('Saved: ' + currentFile, 'success');
  } catch (e) {
    log('Error saving: ' + e.message, 'error');
  }
}

async function testFile() {
  if (!currentFile) {
    log('No file loaded to test', 'error');
    return;
  }
  
  await saveFile();
  log('Launching: ' + currentFile);
  parent.XLine.exec(currentFile);
}

async function newFile() {
  const name = prompt('Enter new file name (e.g., myapp.html):');
  if (!name) return;
  
  const path = name.startsWith('/') ? name : '/apps/' + name;
  const template = \`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>New App</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, sans-serif;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Hello from \${name.replace('.html', '')}!</h1>
  <p>Edit this file in Code Editor.</p>
</body>
</html>\`;
  
  try {
    await parent.XLine.fs.write(path, template);
    log('Created: ' + path, 'success');
    await refreshFileList();
    document.getElementById('file-select').value = path;
    loadFile();
  } catch (e) {
    log('Error creating file: ' + e.message, 'error');
  }
}

async function deleteFile() {
  if (!currentFile) {
    log('No file loaded to delete', 'error');
    return;
  }
  
  if (!confirm('Delete ' + currentFile + '? This cannot be undone!')) {
    return;
  }
  
  try {
    const tx = parent.XLine.db.transaction(['files'], 'readwrite');
    await tx.objectStore('files').delete(currentFile);
    log('Deleted: ' + currentFile, 'success');
    currentFile = null;
    document.getElementById('editor').value = '';
    document.getElementById('file-info').textContent = 'No file loaded';
    document.getElementById('status').textContent = 'File deleted';
    await refreshFileList();
  } catch (e) {
    log('Error deleting: ' + e.message, 'error');
  }
}

document.getElementById('editor').addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 's') {
      e.preventDefault();
      saveFile();
    }
  }
  
  if (e.key === 'Tab') {
    e.preventDefault();
    const textarea = e.target;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + 2;
  }
});

log('Code Editor initialized');
log('Tip: Use Ctrl+S or Cmd+S to save');
refreshFileList();
<\/script></body></html>
